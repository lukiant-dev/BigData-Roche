<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head>
<title>Gratuitous Hadoop: Stress Testing on the Cheap with Hadoop Streaming and EC2 | Cloudera Developer Blog</title>

<meta name="keywords" content="hadoop, hadoop training, cloudera, hadoop tutorial, hadoop certification, apache hadoop, hadoop download, big data, open source" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="msvalidate.01" content="8857B9071A02F989DE3F8BEE557BB584" />

<link rel="search" type="application/opensearchdescription+xml" href="/assets/opensearch.xml" title="Cloudera" />

<meta property="og:title" content="Gratuitous Hadoop: Stress Testing on the Cheap with Hadoop Streaming and EC2"/>
<meta property="og:type" content="article"/>
<meta property="og:url" content="http://blog.cloudera.com/blog/2011/02/gratuitous-hadoop-stress-testing-on-the-cheap-with-hadoop-streaming-and-ec2/"/>
<meta property="og:site_name" content="Cloudera Developer Blog"/>


<link rel="icon" href="/wp-content/themes/solutionset/assets/favicon.ico" type="image/x-icon" /> 
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/960.css?070910" />
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/reset.css?070910" />
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/all.css?20120620" />
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/wp.css?20120620" /> 

<!--[if lt IE 7]><link rel="stylesheet" type="text/css" href="http://blog.cloudera.com/wp-content/themes/solutionset/assets/css/ie6.css?20120605" media="screen"/><![endif]-->
<!--[if lt IE 8]><link rel="stylesheet" type="text/css" href="http://blog.cloudera.com/wp-content/themes/solutionset/assets/css/ie6-7.css?20120605" media="screen"/><![endif]-->
<!--[if lt IE 9]><link rel="stylesheet" type="text/css" href="http://blog.cloudera.com/wp-content/themes/solutionset/assets/css/ie.css?20120605" media="screen"/><![endif]-->

<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/modernizr-2.6.1.min.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/mootools-1.2.4-yui.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/mootools-1.2.4.4-more-yui.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/jquery-1.6.2.min.js"></script>
<script type="text/javascript"> jQuery.noConflict(); </script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/jquery.colorbox-min.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/global.js?20120605"></script>
<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "ur-aa86c136-1042-b30d-950-dd905bb179a0", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script>


<link rel="pingback" href="http://blog.cloudera.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="Cloudera Developer Blog &raquo; Feed" href="http://blog.cloudera.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Cloudera Developer Blog &raquo; Comments Feed" href="http://blog.cloudera.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Cloudera Developer Blog &raquo; Gratuitous Hadoop: Stress Testing on the Cheap with Hadoop Streaming and EC2 Comments Feed" href="http://blog.cloudera.com/blog/2011/02/gratuitous-hadoop-stress-testing-on-the-cheap-with-hadoop-streaming-and-ec2/feed/" />
<link rel='stylesheet' id='prettify-gc-syntax-highlighter-css'  href='http://blog.cloudera.com/wp-content/plugins/prettify-gc-syntax-highlighter/prettify.css?ver=3.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='cptchStylesheet-css'  href='http://blog.cloudera.com/wp-content/plugins/captcha/css/style_wp_before_3.8.css?ver=3.3.2' type='text/css' media='all' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://blog.cloudera.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://blog.cloudera.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Avoiding Full GCs in Apache HBase with MemStore-Local Allocation Buffers: Part 1' href='http://blog.cloudera.com/blog/2011/02/avoiding-full-gcs-in-hbase-with-memstore-local-allocation-buffers-part-1/' />
<link rel='next' title='Supported Operating Systems in CDH3' href='http://blog.cloudera.com/blog/2011/02/supported-operating-systems-in-cdh3-2/' />
<meta name="generator" content="WordPress 3.3.2" />
<link rel='canonical' href='http://blog.cloudera.com/blog/2011/02/gratuitous-hadoop-stress-testing-on-the-cheap-with-hadoop-streaming-and-ec2/' />
<link rel='shortlink' href='http://blog.cloudera.com/?p=6711' />


<script type="text/javascript">
 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-2275969-16']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 })();
</script>


</head>
<body class="single single-post postid-6711 single-format-standard devcenter">
			
		
			
	<header id="site-head">
<nav class="properties">
            <div class="container">
                <ul>
                    <!--<li><a href="http://www.cloudera.com">Cloudera.com</a></li>-->
                     <!--<li><a href="http://university.cloudera.com">Cloudera University</a></li>
                   <li><a href="${config.LINK_CCP}/display/DOC/Documentation">Documentation</a></li>-->
                    <li><a id="support_home_page" href="http://cloudera.com/content/support/en/home.html" class="active">Support</a></li>
                    <li><a href="http://cloudera.com/content/dev-center/en/home.html">Developers</a></li>
                  <!--<li><a href="http://cloudera.com/content/cloudera/en/partners.html">PARTNERS</a></li>-->
                   
                </ul>
                <ul class="user">
                    <li>
                       <!--<a id="signinLink" class="hidden" href="https://clouderapkb.echolane.cs3.force.com/idp/login?app=0spQ00000004CD5">Sign In</a>-->
<a id="signinLink" class="hidden" href="https://cloudera.secure.force.com">Sign In</a>
                    </li>
                    <li><a id="registerLink" class="hidden" href="http://cloudera.com/content/support/en/user-registration.html">Register</a></li>
                    <li><a href="http://cloudera.com/content/cloudera/en/about/contact-us.html">Contact Us</a></li>
                    <li><a href="http://cloudera.com/content/support/en/downloads.html">Downloads</a></li>
                    <li>
                        <div id="dropdownAction" class="dropdown" style="display:none">
                            <a id="lnkDropdowntoogle" data-toggle="dropdown" class="dropdown-toggle" href="#">

                            </a>
                            <ul aria-labelledby="dropdownMenu" tole="menu" class="dropdown-menu">
                                <li><a href="http://cloudera.com/content/support/en/edit-user-profile.html" id="editProfileLink" tabindex="-1">Edit Profile</a></li>
                                <li class="divider"></li>
                                <li>
                                <a id="logoutLink" tabindex="-1" href="#">Logout</a>
                                </script>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="bg-fix"></div>
        </nav>
<!--</div>-->

<div class="wrapper">
    <div class="bg-fix"></div>
    <h1 class="logo">
        <a href="http://cloudera.com/content/cloudera/en/home.html">Cloudera</a>
    </h1>

<nav class="site">
        <ul>
    <li class="">
 <a href="http://community.cloudera.com" data-link="external">Community</a>
</li>
<li class="">
 <a href="http://cloudera.com/content/support/en/documentation.html" data-link="external">Documentation</a>
</li>
 <li class="">
                    <a href="http://cloudera.com/content/support/en/downloads.html" data-link="external">Downloads</a>
   </li>
     <li class="">
                    <a href="http://university.cloudera.com" data-link="external">Training</a>
     </li>
<li class="">
                    <a href="http://blog.cloudera.com" data-link="external" class="active">Blogs</a>
                    <nav class="subnav menu"> <nav><ul>
<li><a href="http://vision.cloudera.com">Cloudera Vision</a></li>
<!--<li><a href="http://blog.cloudera.com/blog">Developer Blog</a></li>-->
</ul>
</nav> </nav>
</li>
            
        </ul>
    </nav>


    <div class="form-holder">
		
	    <form action="http://cloudera.com/content/cloudera/en/search.html" id="site-search" method="get" novalidate> 
	        <label for="q" class="visuallyhidden">Search</label> 
	        <input type="search" name="q" id="q" placeholder="Search"><i class="icon-search"></i> 
	    </form>
    </div>
    </div><!--</div>-->
        </header>
				
	<div role="main" class="main">
		<div class="wrapper">
			<section class="two-col">

	
<aside class="left-col">

				<nav>
			<ul class=" ">
			
								
							<li class="">
				<a
					href="http://www.cloudera.com/content/cloudera/en/why-cloudera/hadoop-and-big-data.html"
					title="Hadoop &amp; Big Data"
					class=""
					target="_blank"				>
					Hadoop &amp; Big Data				</a>

							</li>
			
					<li class="">
				<a
					href="http://www.cloudera.com/content/cloudera/en/why-cloudera/our-customers.html"
					title="Our Customers"
					class=""
					target="_blank"				>
					Our Customers				</a>

							</li>
			
					<li class="">
				<a
					href="http://www.cloudera.com/content/cloudera/en/why-cloudera/faqs.html"
					title="FAQs"
					class=""
					target="_blank"				>
					FAQs				</a>

							</li>
			
					<li class="current">
				<a
					href="/blog/"
					title="Blog"
					class="blog"
									>
					Blog				</a>

									<ul>
									<li class="">
				<a
					href="/blog/category/accumulo/"
					title="Accumulo (1)"
					class=""
									>
					Accumulo (1)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/avro/"
					title="Avro (16)"
					class=""
									>
					Avro (16)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/bigtop/"
					title="Bigtop (6)"
					class=""
									>
					Bigtop (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/books/"
					title="Books (6)"
					class=""
									>
					Books (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/careers/"
					title="Careers (14)"
					class=""
									>
					Careers (14)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cdh/"
					title="CDH (127)"
					class=""
									>
					CDH (127)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cloud-2/"
					title="Cloud (9)"
					class=""
									>
					Cloud (9)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cloudera-life/"
					title="Cloudera Life (3)"
					class=""
									>
					Cloudera Life (3)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cloudera-manager/"
					title="Cloudera Manager (61)"
					class=""
									>
					Cloudera Manager (61)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/community/"
					title="Community (182)"
					class=""
									>
					Community (182)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/data-collection/"
					title="Data Collection (17)"
					class=""
									>
					Data Collection (17)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/data-science/"
					title="Data Science (26)"
					class=""
									>
					Data Science (26)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/distribution/"
					title="Distribution (36)"
					class=""
									>
					Distribution (36)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/events/"
					title="Events (37)"
					class=""
									>
					Events (37)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/flume/"
					title="Flume (18)"
					class=""
									>
					Flume (18)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/general/"
					title="General (327)"
					class=""
									>
					General (327)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/guest/"
					title="Guest (77)"
					class=""
									>
					Guest (77)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hadoop/"
					title="Hadoop (294)"
					class=""
									>
					Hadoop (294)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hardware/"
					title="Hardware (3)"
					class=""
									>
					Hardware (3)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hbase/"
					title="HBase (124)"
					class=""
									>
					HBase (124)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hdfs/"
					title="HDFS (45)"
					class=""
									>
					HDFS (45)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hive/"
					title="Hive (62)"
					class=""
									>
					Hive (62)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/how-to/"
					title="How-to (53)"
					class=""
									>
					How-to (53)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hue/"
					title="Hue (30)"
					class=""
									>
					Hue (30)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/impala/"
					title="Impala (63)"
					class=""
									>
					Impala (63)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/kite-sdk/"
					title="Kite SDK (11)"
					class=""
									>
					Kite SDK (11)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/mahout-2/"
					title="Mahout (5)"
					class=""
									>
					Mahout (5)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/mapreduce/"
					title="MapReduce (71)"
					class=""
									>
					MapReduce (71)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/meet-the-engineer/"
					title="Meet The Engineer (18)"
					class=""
									>
					Meet The Engineer (18)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/oozie/"
					title="Oozie (25)"
					class=""
									>
					Oozie (25)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/ops/"
					title="Ops And DevOps (19)"
					class=""
									>
					Ops And DevOps (19)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/pig/"
					title="Pig (35)"
					class=""
									>
					Pig (35)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/quickstart-vm/"
					title="QuickStart VM (5)"
					class=""
									>
					QuickStart VM (5)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/search/"
					title="Search (21)"
					class=""
									>
					Search (21)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/security-2/"
					title="Security (15)"
					class=""
									>
					Security (15)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/spark/"
					title="Spark (9)"
					class=""
									>
					Spark (9)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/sqoop/"
					title="Sqoop (20)"
					class=""
									>
					Sqoop (20)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/support/"
					title="Support (4)"
					class=""
									>
					Support (4)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/testing/"
					title="Testing (8)"
					class=""
									>
					Testing (8)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/this-month-in-the-ecosystem/"
					title="This Month In The Ecosystem (8)"
					class=""
									>
					This Month In The Ecosystem (8)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/tools/"
					title="Tools (6)"
					class=""
									>
					Tools (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/training-2/"
					title="Training (42)"
					class=""
									>
					Training (42)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/use-case/"
					title="Use Case (59)"
					class=""
									>
					Use Case (59)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/whirr/"
					title="Whirr (6)"
					class=""
									>
					Whirr (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/yarn/"
					title="YARN (13)"
					class=""
									>
					YARN (13)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/zookeeper/"
					title="ZooKeeper (24)"
					class=""
									>
					ZooKeeper (24)				</a>

							</li>
			
					<li class="">
				<a
					href="/archive/"
					title="Archives by Month"
					class=""
									>
					Archives by Month				</a>

							</li>
			
							</ul>
							</li>
			
						
			    
			
				<div style="clear:both"></div>
			</ul>
			</nav>
			<div class="menu-special">
				<ul>
							
				
				
		
				
		
				
				
				
				

		
					</ul>
			</div>
			
</aside>


<section>
			<h1 class="heading ">Gratuitous Hadoop: Stress Testing on the Cheap with Hadoop Streaming and EC2</h1>
			
			<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
			
			<ul class="post-info">
				<li>by <a href="http://blog.cloudera.com/blog/author/jzuanich/" title="Posts by Jon Zuanich (@jonzuanich)" rel="author">Jon Zuanich (@jonzuanich)</a></li>
				<li>February 25, 2011</li>
				<li class="comment"><a href="#comments">2 comments</a></li>
				
			</ul>
			
			<div class="text-block">
				<p><em>This post was contributed by Boris Shimanovsky, the Director of Engineering at <a href="http://www.factual.com/">Factual</a>. Boris is responsible for managing all engineering functions and various data infrastructures at Factual- including the internal Cloudera&#8217;s Distribution for Apache Hadoop stack.  He has been at Factual for over two years, and prior he was the CTO of XAP where he managed a team of +40 across multiple environments.  He has an MS from UCLA in Computer Science.</em></p>
<p>Things have a funny way of working out this way.  A couple features were pushed back from a previous release and some last minute improvements were thrown in, and suddenly we found ourselves dragging out a lot more fresh code in our release than usual.  All this the night before one of our heavy API users was launching something of their own.  They were expecting to hit us thousands of times a second and most of their calls touched some piece of code that hadn&#8217;t been tested in the wild.  Ordinarily, we would soft launch and put the system through its paces.   But now we had no time for that.  We really wanted to hammer the entire stack, yesterday, and so we couldn&#8217;t rely on internal compute resources.</p>
<p>Typically, people turn to a service for this sort of thing but for the load we wanted, they charge many hundreds of dollars.  It was also short notice and after hours, so there was going to be some sort of premium to boot.</p>
<p>At first, I thought we should use something like <a href="http://jakarta.apache.org/jmeter/">JMeter</a> from some EC2 machines.  However, we didn&#8217;t have anything set up for that.  What were we going to do with the stats?  How would we synchronize starting and stopping?  It just seemed like this path was going to take a while.</p>
<p>I wanted to go to bed.  Soon.</p>
<p>We routinely run Hadoop jobs on EC2, so everything was already baked to launch a bunch of machines and run jobs.  Initially, it seemed like a silly idea, but when the hammer was sitting right there, I saw nails.  I Googled it to see if anyone had tried.  Of course not.  Why would they?  And if they did, why admit it?  Perhaps nobody else found themselves on the far right side of the Sleep vs Sensitivity-to-Shame scale.</p>
<div align="center">
<img src="https://www.cloudera.com/wp-content/uploads/2011/02/sleep-vs-shame.png" alt="Sleep vs Sensitivity to Shame" title="Sleep vs Sensitivity to Shame" width="435" height="315" class="aligncenter size-full wp-image-139" /></a>
</div>
<p>So, it was settled &#8212; Hadoop it is!  I asked my colleagues to assemble the list of test URLs.  Along with some static stuff (no big deal) and a couple dozen basic pages, we had a broad mixture of API requests and AJAX calls we needed to simulate.  For the AJAX stuff, we simply grabbed URLs from the Firebug console.  Everything else was already in tests or right on the surface, so we&#8217;d have our new test set in less than an hour.  I figured a few dozen lines of ruby code using Hadoop streaming could probably do what I had in mind.</p>
<p>I&#8217;ve read quite a few post-mortems that start off like this, but read on, it turns out alright.</p>
<h2>Hadoop Streaming</h2>
<p><a href="http://hadoop.apache.org/common/docs/r0.20.1/streaming.html">Hadoop Streaming</a>  is a utility that ships with Hadoop and works with pretty much any language.  Any executable that reads from stdin and writes to stdout can be a mapper or reducer.  By default, they read line-by-line with the bytes up to the first tab character representing the key and any remainder becomes the value.  It&#8217;s a great resource and bridges the power of Hadoop with the ease of quick scripts.  We use it a lot when we need to scale out otherwise simple jobs.</p>
<h2>Designing Our Job</h2>
<p>We had just two basic requirements for our job:</p>
<div style="margin-left:20px">
<ol>
<li>Visit URLs quickly</li>
<li>Produce response time stats</li>
</ol>
</div>
<h2>Input File</h2>
<p>The only input in this project is a list of URLs &#8212; only keys and no values.  The job would have to run millions of URLs through the process to sustain the desired load for the desired time but we only had hundreds of calls that needed testing.  First, we wanted to skew the URL frequency towards the most common calls.  To do that, we just put those URLs in multiple times.  Then we wanted to shuffle them for better distribution.  Finally, we just needed lots of copies.</p>
<pre class="code">for i in {1..10000};  do sort -R < sample_urls_list.txt; done > full_urls_list.txt</pre>
</p>
<h2>Mapper</h2>
<p>The mapper was going to do most of the work for us.  It needed to fetch URLs as quickly as possible and record the elapsed time for each request.  Hadoop processes definitely have overhead and even though each EC2 instance could likely be fetching hundreds of URLs at once, it couldn&#8217;t possibly run hundreds of mappers.  To get past this issue, we had two options: 1) just launch more machines and under-utilize them or 2) fetch lots of URLs concurrently with each mapper.  We&#8217;re trying not to needlessly waste money, so #1 is out.</p>
<p>I had used the <a href="http://curb.rubyforge.org/">curb</a> gem (libcurl bindings for ruby) on several other projects and it worked really well.  It turns out that it was going to be especially helpful here since it has a Multi class which can run concurrent requests each with blocks that function essentially as callbacks.  With a little hackery, it could be turned into a poor/lazy/sleep-deprived man&#8217;s thread pool.</p>
<p>The main loop:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="ruby">
<pre class="code"><span class="re1">@curler</span>.<span class="me1">perform</span> <span class="kw1">do</span>
  flush_buffer!
  STDIN.<span class="me1">take</span><span class="br0">&#40;</span>@concurrent_requests<span class="sy0">-</span>@curler.<span class="me1">requests</span>.<span class="me1">size</span><span class="br0">&#41;</span>.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>url<span class="sy0">|</span>
    add_url<span class="br0">&#40;</span>url.<span class="kw3">chomp</span><span class="br0">&#41;</span>
  <span class="kw1">end</span>
<span class="kw1">end</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Blocks for success and failure:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="ruby">
<pre class="code">curl.<span class="me1">on_success</span> <span class="kw1">do</span>
  <span class="kw1">if</span> errorlike_content?<span class="br0">&#40;</span>curl.<span class="me1">body_str</span><span class="br0">&#41;</span>
    log_error<span class="br0">&#40;</span>curl.<span class="me1">url</span>,<span class="st0">'errorlike content'</span><span class="br0">&#41;</span>
  <span class="kw1">else</span>
    <span class="re1">@response_buffer</span><span class="sy0"><<</span><span class="br0">&#91;</span>curl.<span class="me1">url</span>,<span class="kw4">Time</span>.<span class="me1">now</span><span class="sy0">-</span>start_time<span class="br0">&#93;</span>
  <span class="kw1">end</span>
<span class="kw1">end</span>
curl.<span class="me1">on_failure</span> <span class="kw1">do</span> <span class="sy0">|</span>curl_obj,args<span class="sy0">|</span>
  error_type = args.<span class="me1">first</span>.<span class="me1">to_s</span> <span class="kw1">if</span> args.<span class="me1">is_a</span>?<span class="br0">&#40;</span><span class="kw3">Array</span><span class="br0">&#41;</span>
  log_error<span class="br0">&#40;</span>curl.<span class="me1">url</span>,error_type<span class="br0">&#41;</span>
<span class="kw1">end</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>As you can see, each completion calls a block that outputs the URL and the number of seconds it took to process the request.  A little healthy paranoia about thread safety resulted in the extra steps of buffering and flushing output &#8212; this would ensure we don&#8217;t interleave output coming from multiple callbacks.</p>
<p>If there is an error, the mapper will just emit the URL without an elapsed time as a hint to the stats aggregator.   In addition, it uses the ruby &#8220;warn&#8221; method to emit a line to stderr.  This increments a built-in Hadoop <a href="http://hadoop.apache.org/common/docs/r0.20.1/streaming.html#How+do+I+update+counters+in+streaming+applications%3F">counter</a> mechanism that watches stderr for messages in the following format:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="text">
<pre class="code">reporter:counter:[group],[counter],[amount]</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>in this case the line is:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="text">
<pre class="code">reporter:counter:error,[errortype],1</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>This is a handy way to report what&#8217;s happening while a job is in progress and is surfaced through the standard Hadoop job web interface.</p>
<h2>Mapper-Only Implementation</h2>
<p>The project could actually be done here if all we wanted was raw data to analyze via some stats software or a database.  One could simply cat together the part files from HDFS and start crunching.</p>
<p>In this case, the whole job would look like this:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="bash">
<pre class="code">hadoop  jar <span class="re1">$HADOOP_HOME</span><span class="sy0">/</span>hadoop-streaming.jar                                  \
<span class="re5">-D</span> mapred.map.tasks=<span class="nu0">100</span>                                                        \
<span class="re5">-D</span> mapred.reduce.tasks=<span class="nu0">0</span>                                                       \
<span class="re5">-D</span> mapred.job.name=<span class="st0">&quot;Stress Test - Mapper Only&quot;</span>                                 \
<span class="re5">-D</span> mapred.speculative.execution=<span class="kw2">false</span>                                          \
<span class="re5">-input</span>  <span class="st0">&quot;/mnt/hadoop/urls.txt&quot;</span>                                                 \
<span class="re5">-output</span> <span class="st0">&quot;/mnt/hadoop/stress_output&quot;</span>                                            \
<span class="re5">-mapper</span> <span class="st0">&quot;<span class="es2">$MY_APP_PATH</span>/samples/stress/get_urls.rb 100&quot;</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>and then when it finishes:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="text">
<pre class="code">hadoop dfs -cat /mnt/hadoop/stress_output/part* > my_combined_data.txt</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h2>Reducer</h2>
<p>In our case, I wanted to use the reducer to compute the stats as part of the job.  In Hadoop streaming, a reducer can expect to receive lines through stdin,  sorted by key and that the same key will not find its way to multiple reducers.  This eliminates the requirement that the reducer code track state for more than one key at a time &#8212; it can simply do whatever it does to values associated with a key (e.g. aggregate) and move on when a new key arrives.  This is a good time to mention the <a href="http://hadoop.apache.org/common/docs/r0.20.1/api/org/apache/hadoop/mapred/lib/aggregate/package-summary.html">aggregate</a> package which could be used as the reducer to accumulate stats.  In our case, I wanted to control my mapper output as well as retain the flexibility to not run a reducer altogether and just get raw data.</p>
<p>The streaming job command looks like this:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="bash">
<pre class="code">hadoop  jar <span class="re1">$HADOOP_HOME</span><span class="sy0">/</span>hadoop-streaming.jar                                  \
<span class="re5">-D</span> mapred.map.tasks=<span class="nu0">100</span>                                                        \
<span class="re5">-D</span> mapred.reduce.tasks=<span class="nu0">8</span>                                                       \
<span class="re5">-D</span> mapred.job.name=<span class="st0">&quot;Stress Test - Full&quot;</span>                                 \
<span class="re5">-D</span> mapred.speculative.execution=<span class="kw2">false</span>                                          \
<span class="re5">-input</span>  <span class="st0">&quot;/mnt/hadoop/urls.txt&quot;</span>                                                 \
<span class="re5">-output</span> <span class="st0">&quot;/mnt/hadoop/stress_output&quot;</span>                                            \
<span class="re5">-mapper</span> <span class="st0">&quot;<span class="es2">$MY_APP_PATH</span>/samples/stress/get_urls.rb 100&quot;</span>                          \
<span class="re5">-reducer</span> &#8220;<span class="re1">$MY_APP_PATH</span><span class="sy0">/</span>samples<span class="sy0">/</span>stress<span class="sy0">/</span>stats_aggregator.rb --reducer&#8221;</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>For each key (URL) and value (elapsed time), the following variables get updated</p>
<div style="margin-left:20px">
<ol>
<li>sum &#8211; total time elapsed for all requests</li>
<li>min &#8211; fastest response</li>
<li>max &#8211; slowest response</li>
<li>count &#8211; number of requests processed</li>
</ol>
</div>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="ruby">
<pre class="code">key,val = l.<span class="kw3">chomp</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\t</span>&quot;</span>,<span class="nu0">2</span><span class="br0">&#41;</span>
<span class="kw1">if</span> last_key.<span class="kw2">nil</span>? <span class="sy0">||</span> last_key!=key
  write_stats<span class="br0">&#40;</span>curr_rec<span class="br0">&#41;</span> <span class="kw1">unless</span> last_key.<span class="kw2">nil</span>?
  curr_rec = STATS_TEMPLATE.<span class="me1">dup</span>.<span class="me1">update</span><span class="br0">&#40;</span><span class="re3">:key</span><span class="sy0">=></span>key<span class="br0">&#41;</span>
  last_key=key
<span class="kw1">end</span>
&nbsp;
<span class="kw1">if</span> val <span class="sy0">&amp;&amp;</span> val!=<span class="st0">''</span>
  val=val.<span class="me1">to_f</span>
  curr_rec<span class="br0">&#91;</span><span class="re3">:sum</span><span class="br0">&#93;</span><span class="sy0">+</span>=val
  curr_rec<span class="br0">&#91;</span><span class="re3">:count</span><span class="br0">&#93;</span><span class="sy0">+</span>=<span class="nu0">1</span>
  curr_rec<span class="br0">&#91;</span><span class="re3">:min</span><span class="br0">&#93;</span>=val <span class="kw1">if</span> curr_rec<span class="br0">&#91;</span><span class="re3">:min</span><span class="br0">&#93;</span>.<span class="kw2">nil</span>? <span class="sy0">||</span> val<span class="sy0"><</span>curr_rec<span class="br0">&#91;</span><span class="re3">:min</span><span class="br0">&#93;</span>
  curr_rec<span class="br0">&#91;</span><span class="re3">:max</span><span class="br0">&#93;</span>=val <span class="kw1">if</span> curr_rec<span class="br0">&#91;</span><span class="re3">:max</span><span class="br0">&#93;</span>.<span class="kw2">nil</span>? <span class="sy0">||</span> val<span class="sy0">></span>curr_rec<span class="br0">&#91;</span><span class="re3">:max</span><span class="br0">&#93;</span>
<span class="kw1">else</span>
  curr_rec<span class="br0">&#91;</span><span class="re3">:errors</span><span class="br0">&#93;</span><span class="sy0">+</span>=<span class="nu0">1</span>
<span class="kw1">end</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Finally, as we flush, we compute the overall average for the key.</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="ruby">
<pre class="code"><span class="kw1">def</span> write_stats<span class="br0">&#40;</span>stats_hash<span class="br0">&#41;</span>
  stats_hash<span class="br0">&#91;</span><span class="re3">:average</span><span class="br0">&#93;</span>=stats_hash<span class="br0">&#91;</span><span class="re3">:sum</span><span class="br0">&#93;</span><span class="sy0">/</span>stats_hash<span class="br0">&#91;</span><span class="re3">:count</span><span class="br0">&#93;</span> <span class="kw1">if</span> stats_hash<span class="br0">&#91;</span><span class="re3">:count</span><span class="br0">&#93;</span><span class="sy0">></span><span class="nu0">0</span>
  <span class="kw3">puts</span> stats_hash.<span class="me1">values_at</span><span class="br0">&#40;</span><span class="sy0">*</span>STATS_TEMPLATE.<span class="me1">keys</span><span class="br0">&#41;</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\t</span>&quot;</span><span class="br0">&#41;</span>
<span class="kw1">end</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h2>Final Stats (optional)</h2>
<p>When the job completes, it produces as many part files as there are total reducers.  Before this data can be loaded into, say, a spreadsheet, it needs to be merged and converted into a friendly format.  A few more lines of code get us a csv file that can easily be dropped into your favorite spreadsheet/charting software:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="bash">
<pre class="code">hadoop dfs <span class="re5">-cat</span> <span class="sy0">/</span>mnt<span class="sy0">/</span>hadoop<span class="sy0">/</span>stress_output<span class="sy0">/</span>part<span class="sy0">*</span> <span class="sy0">|</span> <span class="re1">$MY_APP_PATH</span><span class="sy0">/</span>samples<span class="sy0">/</span>stress<span class="sy0">/</span>stats_aggregator.rb <span class="re5">--csv</span> <span class="sy0">></span> final_stats.csv</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>Our CSV converter looks like this:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="ruby">
<pre class="code"><span class="kw1">class</span> CSVConverter
  <span class="kw1">def</span> print_stats
    <span class="kw3">puts</span> STATS_TEMPLATE.<span class="me1">keys</span>.<span class="me1">to_csv</span>
    STDIN.<span class="me1">each_line</span> <span class="kw1">do</span> <span class="sy0">|</span>l<span class="sy0">|</span>
      <span class="kw3">puts</span> l.<span class="kw3">chomp</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\t</span>&quot;</span><span class="br0">&#41;</span>.<span class="me1">to_csv</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
<span class="kw1">end</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h2>Source Code</h2>
<p>The mapper, <i>get_urls.rb</i>:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="ruby">
<pre class="code"><span class="co1">#!/usr/bin/env ruby1.9</span>
<span class="kw3">require</span> <span class="st0">'rubygems'</span>
<span class="kw3">require</span> <span class="st0">'curb'</span>
&nbsp;
<span class="kw1">class</span> MultiCurler
  DEFAULT_CONCURRENT_REQUESTS = <span class="nu0">100</span>
  <span class="kw1">def</span> initialize<span class="br0">&#40;</span>opts=<span class="br0">&#123;</span><span class="br0">&#125;</span><span class="br0">&#41;</span>
    <span class="re1">@concurrent_requests</span> = opts<span class="br0">&#91;</span><span class="re3">:concurrent_requests</span><span class="br0">&#93;</span> <span class="sy0">||</span> DEFAULT_CONCURRENT_REQUESTS
    <span class="re1">@curler</span> = <span class="re2">Curl::Multi</span>.<span class="me1">new</span>
    <span class="re1">@response_buffer</span>=<span class="br0">&#91;</span><span class="br0">&#93;</span>
  <span class="kw1">end</span>
  <span class="kw1">def</span> start
    <span class="kw1">while</span> !STDIN.<span class="me1">eof</span>?
      STDIN.<span class="me1">take</span><span class="br0">&#40;</span>@concurrent_requests<span class="br0">&#41;</span>.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>url<span class="sy0">|</span>
        add_url<span class="br0">&#40;</span>url.<span class="kw3">chomp</span><span class="br0">&#41;</span>
      <span class="kw1">end</span>
      run
    <span class="kw1">end</span>
  <span class="kw1">end</span>
&nbsp;
  private
&nbsp;
  <span class="kw1">def</span> run
    <span class="re1">@curler</span>.<span class="me1">perform</span> <span class="kw1">do</span>
      flush_buffer!
      STDIN.<span class="me1">take</span><span class="br0">&#40;</span>@concurrent_requests<span class="sy0">-</span>@curler.<span class="me1">requests</span>.<span class="me1">size</span><span class="br0">&#41;</span>.<span class="me1">each</span> <span class="kw1">do</span> <span class="sy0">|</span>url<span class="sy0">|</span>
        add_url<span class="br0">&#40;</span>url.<span class="kw3">chomp</span><span class="br0">&#41;</span>
      <span class="kw1">end</span>
    <span class="kw1">end</span>
    flush_buffer!
  <span class="kw1">end</span>
&nbsp;
  <span class="kw1">def</span> flush_buffer!
    <span class="kw1">while</span> output = <span class="re1">@response_buffer</span>.<span class="me1">pop</span>
      <span class="kw3">puts</span> output.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\t</span>&quot;</span><span class="br0">&#41;</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
&nbsp;
  <span class="kw1">def</span> add_url<span class="br0">&#40;</span>u<span class="br0">&#41;</span>
&nbsp;
    <span class="co1">#skip really obvious input errors</span>
    <span class="kw2">return</span> log_error<span class="br0">&#40;</span>u,<span class="st0">'missing url'</span><span class="br0">&#41;</span> <span class="kw1">if</span> u.<span class="kw2">nil</span>?
    <span class="kw2">return</span> log_error<span class="br0">&#40;</span>u,<span class="st0">'invalid url'</span><span class="br0">&#41;</span> <span class="kw1">unless</span> u=~<span class="sy0">/</span>^http:\<span class="sy0">/</span>\<span class="sy0">//</span>i
&nbsp;
    c = <span class="re2">Curl::Easy</span>.<span class="me1">new</span><span class="br0">&#40;</span>u<span class="br0">&#41;</span> <span class="kw1">do</span><span class="sy0">|</span>curl<span class="sy0">|</span>
      start_time = <span class="kw4">Time</span>.<span class="me1">now</span>
      curl.<span class="me1">follow_location</span> = <span class="kw2">true</span>
      curl.<span class="me1">enable_cookies</span>=<span class="kw2">true</span>
      curl.<span class="me1">on_success</span> <span class="kw1">do</span>
        <span class="kw1">if</span> errorlike_content?<span class="br0">&#40;</span>curl.<span class="me1">body_str</span><span class="br0">&#41;</span>
          log_error<span class="br0">&#40;</span>curl.<span class="me1">url</span>,<span class="st0">'errorlike content'</span><span class="br0">&#41;</span>
        <span class="kw1">else</span>
          <span class="re1">@response_buffer</span><span class="sy0"><<</span><span class="br0">&#91;</span>curl.<span class="me1">url</span>,<span class="kw4">Time</span>.<span class="me1">now</span><span class="sy0">-</span>start_time<span class="br0">&#93;</span>
        <span class="kw1">end</span>
      <span class="kw1">end</span>
      curl.<span class="me1">on_failure</span> <span class="kw1">do</span> <span class="sy0">|</span>curl_obj,args<span class="sy0">|</span>
        error_type = args.<span class="me1">first</span>.<span class="me1">to_s</span> <span class="kw1">if</span> args.<span class="me1">is_a</span>?<span class="br0">&#40;</span><span class="kw3">Array</span><span class="br0">&#41;</span>
        log_error<span class="br0">&#40;</span>curl.<span class="me1">url</span>,error_type<span class="br0">&#41;</span>
      <span class="kw1">end</span>
    <span class="kw1">end</span>
    <span class="re1">@curler</span>.<span class="me1">add</span><span class="br0">&#40;</span>c<span class="br0">&#41;</span>
  <span class="kw1">end</span>
&nbsp;
  <span class="kw1">def</span> errorlike_content?<span class="br0">&#40;</span>page_body<span class="br0">&#41;</span>
    page_body.<span class="kw2">nil</span>? <span class="sy0">||</span> page_body==<span class="st0">''</span> <span class="sy0">||</span> page_body=~<span class="sy0">/</span><span class="br0">&#40;</span>unexpected error<span class="sy0">|</span>something went wrong<span class="sy0">|</span><span class="re2">Api::Error</span><span class="br0">&#41;</span><span class="sy0">/</span>i
  <span class="kw1">end</span>
&nbsp;
  <span class="kw1">def</span> log_error<span class="br0">&#40;</span>url,error_type<span class="br0">&#41;</span>
    <span class="re1">@response_buffer</span><span class="sy0"><<</span><span class="br0">&#91;</span>url,<span class="kw2">nil</span><span class="br0">&#93;</span>
    warn <span class="st0">&quot;reporter:counter:error,#{error_type||'unknown'},1&quot;</span>
  <span class="kw1">end</span>
&nbsp;
<span class="kw1">end</span>
&nbsp;
&nbsp;
concurrent_requests = ARGV.<span class="me1">first</span> ? ARGV.<span class="me1">first</span>.<span class="me1">to_i</span> : <span class="kw2">nil</span>
&nbsp;
runner=MultiCurler.<span class="me1">new</span><span class="br0">&#40;</span><span class="re3">:concurrent_requests</span><span class="sy0">=></span>concurrent_requests<span class="br0">&#41;</span>
runner.<span class="me1">start</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>The reducer and postprocessing script, <i>stats_aggregator.rb</i>:</p>
<div class="wp-geshi-highlight-wrap5">
<div class="wp-geshi-highlight-wrap4">
<div class="wp-geshi-highlight-wrap3">
<div class="wp-geshi-highlight-wrap2">
<div class="wp-geshi-highlight-wrap">
<div class="wp-geshi-highlight">
<div class="ruby">
<pre class="code"><span class="co1">#!/usr/bin/env ruby1.9</span>
<span class="kw3">require</span> <span class="st0">'rubygems'</span>
<span class="kw3">require</span> <span class="st0">'csv'</span>
&nbsp;
&nbsp;
<span class="kw1">module</span> Stats
  STATS_TEMPLATE=<span class="br0">&#123;</span>:key<span class="sy0">=></span>nil,:sum<span class="sy0">=></span><span class="nu0">0</span>,:average<span class="sy0">=></span>nil,:max<span class="sy0">=></span>nil,:min<span class="sy0">=></span>nil,:errors<span class="sy0">=></span><span class="nu0">0</span>,:count<span class="sy0">=></span><span class="nu0">0</span><span class="br0">&#125;</span>
&nbsp;
  <span class="kw1">class</span> Reducer
    <span class="kw1">def</span> run
&nbsp;
      last_key=<span class="kw2">nil</span>
      curr_rec=<span class="kw2">nil</span>
&nbsp;
      STDIN.<span class="me1">each_line</span> <span class="kw1">do</span> <span class="sy0">|</span>l<span class="sy0">|</span>
        key,val = l.<span class="kw3">chomp</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\t</span>&quot;</span>,<span class="nu0">2</span><span class="br0">&#41;</span>
        <span class="kw1">if</span> last_key.<span class="kw2">nil</span>? <span class="sy0">||</span> last_key!=key
          write_stats<span class="br0">&#40;</span>curr_rec<span class="br0">&#41;</span> <span class="kw1">unless</span> last_key.<span class="kw2">nil</span>?
          curr_rec = STATS_TEMPLATE.<span class="me1">dup</span>.<span class="me1">update</span><span class="br0">&#40;</span><span class="re3">:key</span><span class="sy0">=></span>key<span class="br0">&#41;</span>
          last_key=key
        <span class="kw1">end</span>
&nbsp;
        <span class="kw1">if</span> val <span class="sy0">&amp;&amp;</span> val!=<span class="st0">''</span>
          val=val.<span class="me1">to_f</span>
          curr_rec<span class="br0">&#91;</span><span class="re3">:sum</span><span class="br0">&#93;</span><span class="sy0">+</span>=val
          curr_rec<span class="br0">&#91;</span><span class="re3">:count</span><span class="br0">&#93;</span><span class="sy0">+</span>=<span class="nu0">1</span>
          curr_rec<span class="br0">&#91;</span><span class="re3">:min</span><span class="br0">&#93;</span>=val <span class="kw1">if</span> curr_rec<span class="br0">&#91;</span><span class="re3">:min</span><span class="br0">&#93;</span>.<span class="kw2">nil</span>? <span class="sy0">||</span> val<span class="sy0"><</span>curr_rec<span class="br0">&#91;</span><span class="re3">:min</span><span class="br0">&#93;</span>
          curr_rec<span class="br0">&#91;</span><span class="re3">:max</span><span class="br0">&#93;</span>=val <span class="kw1">if</span> curr_rec<span class="br0">&#91;</span><span class="re3">:max</span><span class="br0">&#93;</span>.<span class="kw2">nil</span>? <span class="sy0">||</span> val<span class="sy0">></span>curr_rec<span class="br0">&#91;</span><span class="re3">:max</span><span class="br0">&#93;</span>
        <span class="kw1">else</span>
          curr_rec<span class="br0">&#91;</span><span class="re3">:errors</span><span class="br0">&#93;</span><span class="sy0">+</span>=<span class="nu0">1</span>
        <span class="kw1">end</span>
      <span class="kw1">end</span>
      write_stats<span class="br0">&#40;</span>curr_rec<span class="br0">&#41;</span> <span class="kw1">if</span> curr_rec
    <span class="kw1">end</span>
&nbsp;
    private
&nbsp;
    <span class="kw1">def</span> write_stats<span class="br0">&#40;</span>stats_hash<span class="br0">&#41;</span>
      stats_hash<span class="br0">&#91;</span><span class="re3">:average</span><span class="br0">&#93;</span>=stats_hash<span class="br0">&#91;</span><span class="re3">:sum</span><span class="br0">&#93;</span><span class="sy0">/</span>stats_hash<span class="br0">&#91;</span><span class="re3">:count</span><span class="br0">&#93;</span> <span class="kw1">if</span> stats_hash<span class="br0">&#91;</span><span class="re3">:count</span><span class="br0">&#93;</span><span class="sy0">></span><span class="nu0">0</span>
      <span class="kw3">puts</span> stats_hash.<span class="me1">values_at</span><span class="br0">&#40;</span><span class="sy0">*</span>STATS_TEMPLATE.<span class="me1">keys</span><span class="br0">&#41;</span>.<span class="me1">join</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\t</span>&quot;</span><span class="br0">&#41;</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
&nbsp;
&nbsp;
  <span class="kw1">class</span> CSVConverter
    <span class="kw1">def</span> print_stats
      <span class="kw3">puts</span> STATS_TEMPLATE.<span class="me1">keys</span>.<span class="me1">to_csv</span>
      STDIN.<span class="me1">each_line</span> <span class="kw1">do</span> <span class="sy0">|</span>l<span class="sy0">|</span>
        <span class="kw3">puts</span> l.<span class="kw3">chomp</span>.<span class="kw3">split</span><span class="br0">&#40;</span><span class="st0">&quot;<span class="es0">\t</span>&quot;</span><span class="br0">&#41;</span>.<span class="me1">to_csv</span>
      <span class="kw1">end</span>
    <span class="kw1">end</span>
  <span class="kw1">end</span>
&nbsp;
&nbsp;
<span class="kw1">end</span>
&nbsp;
&nbsp;
mode = ARGV.<span class="me1">shift</span>
&nbsp;
<span class="kw1">case</span> mode
  <span class="kw1">when</span> <span class="st0">'--reducer'</span> <span class="co1">#hadoop mode</span>
    <span class="re2">Stats::Reducer</span>.<span class="me1">new</span>.<span class="me1">run</span>
  <span class="kw1">when</span> <span class="st0">'--csv'</span> <span class="co1">#csv converter; run with: hadoop dfs -cat /mnt/hadoop/stress_output/part* | stats_aggregator.rb --csv</span>
    <span class="re2">Stats::CSVConverter</span>.<span class="me1">new</span>.<span class="me1">print_stats</span>
  <span class="kw1">else</span>
    abort <span class="st0">'Invalid mode specified for stats aggregator.  Valid options are --reducer, --csv'</span>
<span class="kw1">end</span></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<h2>Reckoning (Shame Computation)</h2>
<p>In a moment of desperation, we used Hadoop to solve a problem for which it is very tenuously appropriate, but it actually turned out great. I wrote very little code and it worked with almost no iteration and just a couple of up-front hours invested for an easily repeatable process. Our last minute stress test exposed a few issues that we were able to quickly correct and resulted in a smooth launch. All this, and it only cost us about $10 of EC2 time.</p>
<p>Hadoop Streaming is a powerful tool that every Hadoop shop, even the pure Java shops, should consider part of their toolbox. Lots of big data jobs are actually simple except for scale, so your local python, ruby, bash, perl, or whatever coder along with some EC2 dollars can give you access to some pretty powerful stuff.</p>
<p>We recommend using <a href="http://www.cloudera.com/hadoop/">Cloudera&#8217;s Distribution for Apache Hadoop</a> and using tools like Whirr to get things running quickly.  It definitely lowers the learning curve for getting going.</p>

				<div class="social-buttons">
<span class='st_facebook_large' displayText='Facebook'></span>
<span class='st_twitter_large' displayText='Tweet'></span>
<span class='st_linkedin_large' displayText='LinkedIn'></span>
<span class='st_googleplus_large' displayText='Google +'></span>
<span class='st_email_large' displayText='Email'></span>
				</div>
			</div>

			<div class="grid_2" style="margin:0">
  <div class="comments comments-2">
    <div class="field-under">
      <h4>Filed under:</h4>
      <ul class="post-categories">
	<li><a href="http://blog.cloudera.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a></li>
	<li><a href="http://blog.cloudera.com/blog/category/hadoop/" title="View all posts in Hadoop" rel="category tag">Hadoop</a></li></ul>  	</div>
  	
  <a name="comments"></a>
  <div class="comments-head">
    <strong>2 Responses</strong>
   
  </div>
  <ul class="comments-list">
  	<li>
		<em class="comment-date">
			<a rel="nofollow" href="http://www.stressreliefpack.com/">Stress Relief</a> /
			March 04, 2011 / 12:51 AM		</em>
		<p>A good  way to describe the stress level .<br />
 &amp; how we can treat with saving money.</p>
	</li>
</li>
  </ul>
  <a name="leave-comment"></a>
  <form action="/wp-comments-post.php" method="POST">
  	<div class="comment-form">
  		<h4>Leave a comment</h4>
  		<div class="row">
  			<input type="text" value="" class="txt" name="author"/>
  			<label>Name <span>required</span></label>
  		</div>
  		<div class="row">
  			<input type="text" value="" class="txt" name="email"/>
  			<label class="published">Email <span>required</span> <em>(will not be published)</em></label>
  		</div>
  		<div class="row">
  			<input type="text" value="" class="txt" name="url"/>
  			<label>Website</label>
  		</div>
  		<div class="row">
  			<textarea rows="10" cols="30" class="area" name="comment"></textarea>
  			<label>Comment</label>
  		</div>
  		<fieldset>
  			<input type="button" value="Leave Comment" class="btn cta"/>
  		</fieldset>
  	</div>
  	<input type='hidden' name='comment_post_ID' value='6711' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
  	<p class="cptch_block"><label>Prove you're human!<span class="required"> *</span></label><br />		<input type="hidden" name="cptch_result" value="Tnc=" />
		<input type="hidden" name="cptch_time" value="1398162944" />
		<input type="hidden" value="Version: 2.4" />
		ni&#110;&#101; &minus; 1 =  <input id="cptch_input" type="text" autocomplete="off" name="cptch_number" value="" maxlength="2" size="2" aria-required="true" required="required" style="margin-bottom:0;display:inline;font-size: 12px;width: 40px;" />	</p>  </form>
</div></section>




<!-- Google Code for New Remarketing Pixel -->
<!-- Remarketing tags may not be associated with personally identifiable information or placed on pages related to sensitive categories. For instructions on adding this tag and more information on the above requirements, read the setup guide: google.com/ads/remarketingsetup -->
<script type="text/javascript">
/* <![CDATA[ */
var google_conversion_id = 1035979479;
var google_conversion_label = "xel9CJ-P0QMQ15X_7QM";
var google_custom_params = window.google_tag_params;
var google_remarketing_only = true;
/* ]]> */
</script>
<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">
</script>

<noscript>
<div style="display:inline;"> <img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1035979479/?value=0&label=xel9CJ-P0QMQ15X_7QM&guid=ON&script=0"/> </div>
</noscript>
</section>
<span class="bg-fix"></span>
</div>
</div>
<footer id="global-footer">
<div class="footerContent parbase">
<footer>
  <div class="wrapper">
    <div class="bg-fix"></div>
    <nav>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/products-and-services.html">Products</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products/cloudera-enterprise.html">Cloudera Enterprise</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/cloudera-express.html">Cloudera Express</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/cloudera-enterprise/cloudera-manager.html">Cloudera Manager</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/cdh.html">CDH</a></li>
        <li><a href="http://www.cloudera.com/content/support/en/downloads.html">All Downloads</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/professional-services.html">Professional Services</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/training.html">Training</a></li>
      </ul>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/solutions.html">Solutions</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/solutions/enterprise-solutions.html">Enterprise Solutions</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/solutions/partner.html">Partner Solutions</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/solutions/industries.html">Industry Solutions</a></li>
      </ul>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/partners.html">Partners</a></li>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/resources/library.html">Resource Library</a></li>
        <li class="section"><a href="https://ccp.cloudera.com/display/SUPPORT/Get+Support">Support</a></li>
      </ul>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/about.html">About</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/hadoop-and-big-data.html">Hadoop &amp; Big Data</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/management.html">Management Team</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/board.html">Board</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/events.html">Events</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/press-center.html">Press Center</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/careers.html">Careers</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/contact-form.html">Contact Us</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/subscription-center.html">Subscription Center</a></li>
      </ul>
      <div class="locale-and-social" style="float:right">
        <div>
          <div class="locale-and-social">
            <div class="locale">
              <select onchange="this.options[this.selectedIndex].value &amp;&amp; (window.location = this.options[this.selectedIndex].value);" class="site-language">
                <option value="http://www.cloudera.com" name="English">English</option>
                <option value="http://www.cloudera.co.jp/">Japanese</option>
              </select>
            </div>
            <div class="social"><span class="follow">Follow us:</span><span class="share">Share:<i class="icon-share"></i></span>
              <ul>
                <li><a class="linkedIn" target="_blank" href="http://www.linkedin.com/company/cloudera">LinkedIn</a></li>
                <li><a class="twitter" target="_blank" href="http://twitter.com/cloudera">Twitter</a></li>
                <li><a class="facebook" target="_blank" href="http://www.facebook.com/cloudera">Facebook</a></li>
                <li><a class="youtube" target="_blank" href="http://www.youtube.com/user/clouderahadoop">YouTube</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <nav class="global-footer"><span class="logo"><a>Cloudera</a></span>
      <address>
      <span>Cloudera, Inc.</span> <span><a target="_blank" href="http://www.google.com/maps?q=1001+Page+Mill+Rd,+Palo+Alto,+CA+94306">1001 Page Mill Road Bldg 2</a></span> <span>Palo Alto, CA 94304</span>
      </address>
      <address>
      <span><a href="http://www.cloudera.com">www.cloudera.com</a></span> <span>US: 1-888-789-1488</span> <span>Intl: 1-650-362-0488</span>
      </address>
      <div class="copyright"><span><span class="piped">2014 Cloudera, Inc. All rights reserved</span><span class="piped"><a href="http://www.cloudera.com/content/cloudera/en/terms-of-service.html">Terms &amp; Conditions</a></span><a href="http://www.cloudera.com/content/cloudera/en/privacy-policy.html">Privacy Policy</a></span> <span>Hadoop and the Hadoop elephant logo are trademarks of the <a target="_blank" href="http://www.apache.org/">Apache Software Foundation</a>.</span></div>
    </nav>
  </div>
</footer>
<script type='text/javascript' src='http://blog.cloudera.com/wp-content/plugins/prettify-gc-syntax-highlighter/prettify.js?ver=3.3.2'></script>
<script type='text/javascript' src='http://blog.cloudera.com/wp-content/plugins/prettify-gc-syntax-highlighter/launch.js?ver=3.3.2'></script>
<div class="modal" style="display:none">
  <div id="password-required">
    <div class="inner"> </div>
  </div>
</div>
<div class="tooltip" class="tooltip" style="display:none">
</div>
<script type="text/javascript" src="http://dnn506yrbagrg.cloudfront.net/pages/scripts/0011/2160.js"></script>
<script type="text/javascript">var _kiq = _kiq || [];</script> 
<script type="text/javascript" src="http://s3.amazonaws.com/ki.js/14646/2Sr.js" async></script>
</body></html>
