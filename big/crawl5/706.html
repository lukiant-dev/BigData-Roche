<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">
<head>
<title>Grouping Related Trends with Hadoop and Hive | Cloudera Developer Blog</title>

<meta name="keywords" content="hadoop, hadoop training, cloudera, hadoop tutorial, hadoop certification, apache hadoop, hadoop download, big data, open source" />
<meta name="description" content="" />
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="msvalidate.01" content="8857B9071A02F989DE3F8BEE557BB584" />

<link rel="search" type="application/opensearchdescription+xml" href="/assets/opensearch.xml" title="Cloudera" />

<meta property="og:title" content="Grouping Related Trends with Hadoop and Hive"/>
<meta property="og:type" content="article"/>
<meta property="og:url" content="http://blog.cloudera.com/blog/2009/09/grouping-related-trends-with-hadoop-and-hive/"/>
<meta property="og:site_name" content="Cloudera Developer Blog"/>


<link rel="icon" href="/wp-content/themes/solutionset/assets/favicon.ico" type="image/x-icon" /> 
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/960.css?070910" />
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/reset.css?070910" />
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/all.css?20120620" />
<link rel="stylesheet" media="all" type="text/css" href="/wp-content/themes/solutionset/assets/css/wp.css?20120620" /> 

<!--[if lt IE 7]><link rel="stylesheet" type="text/css" href="http://blog.cloudera.com/wp-content/themes/solutionset/assets/css/ie6.css?20120605" media="screen"/><![endif]-->
<!--[if lt IE 8]><link rel="stylesheet" type="text/css" href="http://blog.cloudera.com/wp-content/themes/solutionset/assets/css/ie6-7.css?20120605" media="screen"/><![endif]-->
<!--[if lt IE 9]><link rel="stylesheet" type="text/css" href="http://blog.cloudera.com/wp-content/themes/solutionset/assets/css/ie.css?20120605" media="screen"/><![endif]-->

<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/modernizr-2.6.1.min.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/mootools-1.2.4-yui.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/mootools-1.2.4.4-more-yui.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/jquery-1.6.2.min.js"></script>
<script type="text/javascript"> jQuery.noConflict(); </script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/jquery.colorbox-min.js"></script>
<script type="text/javascript" src="/wp-content/themes/solutionset/assets/js/global.js?20120605"></script>
<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "ur-aa86c136-1042-b30d-950-dd905bb179a0", doNotHash: true, doNotCopy: true, hashAddressBar: false});</script>


<link rel="pingback" href="http://blog.cloudera.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="Cloudera Developer Blog &raquo; Feed" href="http://blog.cloudera.com/feed/" />
<link rel="alternate" type="application/rss+xml" title="Cloudera Developer Blog &raquo; Comments Feed" href="http://blog.cloudera.com/comments/feed/" />
<link rel="alternate" type="application/rss+xml" title="Cloudera Developer Blog &raquo; Grouping Related Trends with Hadoop and Hive Comments Feed" href="http://blog.cloudera.com/blog/2009/09/grouping-related-trends-with-hadoop-and-hive/feed/" />
<link rel='stylesheet' id='prettify-gc-syntax-highlighter-css'  href='http://blog.cloudera.com/wp-content/plugins/prettify-gc-syntax-highlighter/prettify.css?ver=3.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='cptchStylesheet-css'  href='http://blog.cloudera.com/wp-content/plugins/captcha/css/style_wp_before_3.8.css?ver=3.3.2' type='text/css' media='all' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://blog.cloudera.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://blog.cloudera.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Apache Hadoop Log Files: Where to find them in CDH, and what info they contain' href='http://blog.cloudera.com/blog/2009/09/apache-hadoop-log-files-where-to-find-them-in-cdh-and-what-info-they-contain/' />
<link rel='next' title='Apache HBase Available in CDH2' href='http://blog.cloudera.com/blog/2009/09/hbase-available-in-cdh2/' />
<meta name="generator" content="WordPress 3.3.2" />
<link rel='canonical' href='http://blog.cloudera.com/blog/2009/09/grouping-related-trends-with-hadoop-and-hive/' />
<link rel='shortlink' href='http://blog.cloudera.com/?p=1350' />


<script type="text/javascript">
 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-2275969-16']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 })();
</script>


</head>
<body class="single single-post postid-1350 single-format-standard devcenter">
			
		
			
	<header id="site-head">
<nav class="properties">
            <div class="container">
                <ul>
                    <!--<li><a href="http://www.cloudera.com">Cloudera.com</a></li>-->
                     <!--<li><a href="http://university.cloudera.com">Cloudera University</a></li>
                   <li><a href="${config.LINK_CCP}/display/DOC/Documentation">Documentation</a></li>-->
                    <li><a id="support_home_page" href="http://cloudera.com/content/support/en/home.html" class="active">Support</a></li>
                    <li><a href="http://cloudera.com/content/dev-center/en/home.html">Developers</a></li>
                  <!--<li><a href="http://cloudera.com/content/cloudera/en/partners.html">PARTNERS</a></li>-->
                   
                </ul>
                <ul class="user">
                    <li>
                       <!--<a id="signinLink" class="hidden" href="https://clouderapkb.echolane.cs3.force.com/idp/login?app=0spQ00000004CD5">Sign In</a>-->
<a id="signinLink" class="hidden" href="https://cloudera.secure.force.com">Sign In</a>
                    </li>
                    <li><a id="registerLink" class="hidden" href="http://cloudera.com/content/support/en/user-registration.html">Register</a></li>
                    <li><a href="http://cloudera.com/content/cloudera/en/about/contact-us.html">Contact Us</a></li>
                    <li><a href="http://cloudera.com/content/support/en/downloads.html">Downloads</a></li>
                    <li>
                        <div id="dropdownAction" class="dropdown" style="display:none">
                            <a id="lnkDropdowntoogle" data-toggle="dropdown" class="dropdown-toggle" href="#">

                            </a>
                            <ul aria-labelledby="dropdownMenu" tole="menu" class="dropdown-menu">
                                <li><a href="http://cloudera.com/content/support/en/edit-user-profile.html" id="editProfileLink" tabindex="-1">Edit Profile</a></li>
                                <li class="divider"></li>
                                <li>
                                <a id="logoutLink" tabindex="-1" href="#">Logout</a>
                                </script>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="bg-fix"></div>
        </nav>
<!--</div>-->

<div class="wrapper">
    <div class="bg-fix"></div>
    <h1 class="logo">
        <a href="http://cloudera.com/content/cloudera/en/home.html">Cloudera</a>
    </h1>

<nav class="site">
        <ul>
    <li class="">
 <a href="http://community.cloudera.com" data-link="external">Community</a>
</li>
<li class="">
 <a href="http://cloudera.com/content/support/en/documentation.html" data-link="external">Documentation</a>
</li>
 <li class="">
                    <a href="http://cloudera.com/content/support/en/downloads.html" data-link="external">Downloads</a>
   </li>
     <li class="">
                    <a href="http://university.cloudera.com" data-link="external">Training</a>
     </li>
<li class="">
                    <a href="http://blog.cloudera.com" data-link="external" class="active">Blogs</a>
                    <nav class="subnav menu"> <nav><ul>
<li><a href="http://vision.cloudera.com">Cloudera Vision</a></li>
<!--<li><a href="http://blog.cloudera.com/blog">Developer Blog</a></li>-->
</ul>
</nav> </nav>
</li>
            
        </ul>
    </nav>


    <div class="form-holder">
		
	    <form action="http://cloudera.com/content/cloudera/en/search.html" id="site-search" method="get" novalidate> 
	        <label for="q" class="visuallyhidden">Search</label> 
	        <input type="search" name="q" id="q" placeholder="Search"><i class="icon-search"></i> 
	    </form>
    </div>
    </div><!--</div>-->
        </header>
				
	<div role="main" class="main">
		<div class="wrapper">
			<section class="two-col">

	
<aside class="left-col">

				<nav>
			<ul class=" ">
			
								
							<li class="">
				<a
					href="http://www.cloudera.com/content/cloudera/en/why-cloudera/hadoop-and-big-data.html"
					title="Hadoop &amp; Big Data"
					class=""
					target="_blank"				>
					Hadoop &amp; Big Data				</a>

							</li>
			
					<li class="">
				<a
					href="http://www.cloudera.com/content/cloudera/en/why-cloudera/our-customers.html"
					title="Our Customers"
					class=""
					target="_blank"				>
					Our Customers				</a>

							</li>
			
					<li class="">
				<a
					href="http://www.cloudera.com/content/cloudera/en/why-cloudera/faqs.html"
					title="FAQs"
					class=""
					target="_blank"				>
					FAQs				</a>

							</li>
			
					<li class="current">
				<a
					href="/blog/"
					title="Blog"
					class="blog"
									>
					Blog				</a>

									<ul>
									<li class="">
				<a
					href="/blog/category/accumulo/"
					title="Accumulo (1)"
					class=""
									>
					Accumulo (1)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/avro/"
					title="Avro (16)"
					class=""
									>
					Avro (16)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/bigtop/"
					title="Bigtop (6)"
					class=""
									>
					Bigtop (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/books/"
					title="Books (6)"
					class=""
									>
					Books (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/careers/"
					title="Careers (14)"
					class=""
									>
					Careers (14)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cdh/"
					title="CDH (127)"
					class=""
									>
					CDH (127)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cloud-2/"
					title="Cloud (9)"
					class=""
									>
					Cloud (9)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cloudera-life/"
					title="Cloudera Life (3)"
					class=""
									>
					Cloudera Life (3)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/cloudera-manager/"
					title="Cloudera Manager (61)"
					class=""
									>
					Cloudera Manager (61)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/community/"
					title="Community (182)"
					class=""
									>
					Community (182)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/data-collection/"
					title="Data Collection (17)"
					class=""
									>
					Data Collection (17)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/data-science/"
					title="Data Science (26)"
					class=""
									>
					Data Science (26)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/distribution/"
					title="Distribution (36)"
					class=""
									>
					Distribution (36)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/events/"
					title="Events (37)"
					class=""
									>
					Events (37)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/flume/"
					title="Flume (18)"
					class=""
									>
					Flume (18)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/general/"
					title="General (327)"
					class=""
									>
					General (327)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/guest/"
					title="Guest (77)"
					class=""
									>
					Guest (77)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hadoop/"
					title="Hadoop (293)"
					class=""
									>
					Hadoop (293)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hardware/"
					title="Hardware (3)"
					class=""
									>
					Hardware (3)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hbase/"
					title="HBase (124)"
					class=""
									>
					HBase (124)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hdfs/"
					title="HDFS (45)"
					class=""
									>
					HDFS (45)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hive/"
					title="Hive (62)"
					class=""
									>
					Hive (62)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/how-to/"
					title="How-to (53)"
					class=""
									>
					How-to (53)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/hue/"
					title="Hue (30)"
					class=""
									>
					Hue (30)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/impala/"
					title="Impala (63)"
					class=""
									>
					Impala (63)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/kite-sdk/"
					title="Kite SDK (11)"
					class=""
									>
					Kite SDK (11)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/mahout-2/"
					title="Mahout (5)"
					class=""
									>
					Mahout (5)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/mapreduce/"
					title="MapReduce (71)"
					class=""
									>
					MapReduce (71)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/meet-the-engineer/"
					title="Meet The Engineer (18)"
					class=""
									>
					Meet The Engineer (18)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/oozie/"
					title="Oozie (25)"
					class=""
									>
					Oozie (25)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/ops/"
					title="Ops And DevOps (19)"
					class=""
									>
					Ops And DevOps (19)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/pig/"
					title="Pig (35)"
					class=""
									>
					Pig (35)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/quickstart-vm/"
					title="QuickStart VM (5)"
					class=""
									>
					QuickStart VM (5)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/search/"
					title="Search (21)"
					class=""
									>
					Search (21)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/security-2/"
					title="Security (15)"
					class=""
									>
					Security (15)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/spark/"
					title="Spark (9)"
					class=""
									>
					Spark (9)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/sqoop/"
					title="Sqoop (20)"
					class=""
									>
					Sqoop (20)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/support/"
					title="Support (4)"
					class=""
									>
					Support (4)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/testing/"
					title="Testing (8)"
					class=""
									>
					Testing (8)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/this-month-in-the-ecosystem/"
					title="This Month In The Ecosystem (8)"
					class=""
									>
					This Month In The Ecosystem (8)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/tools/"
					title="Tools (6)"
					class=""
									>
					Tools (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/training-2/"
					title="Training (42)"
					class=""
									>
					Training (42)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/use-case/"
					title="Use Case (59)"
					class=""
									>
					Use Case (59)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/whirr/"
					title="Whirr (6)"
					class=""
									>
					Whirr (6)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/yarn/"
					title="YARN (12)"
					class=""
									>
					YARN (12)				</a>

							</li>
			
					<li class="">
				<a
					href="/blog/category/zookeeper/"
					title="ZooKeeper (24)"
					class=""
									>
					ZooKeeper (24)				</a>

							</li>
			
					<li class="">
				<a
					href="/archive/"
					title="Archives by Month"
					class=""
									>
					Archives by Month				</a>

							</li>
			
							</ul>
							</li>
			
						
			    
			
				<div style="clear:both"></div>
			</ul>
			</nav>
			<div class="menu-special">
				<ul>
							
				
				
		
				
		
				
				
				
				

		
					</ul>
			</div>
			
</aside>


<section>
			<h1 class="heading ">Grouping Related Trends with Hadoop and Hive</h1>
			
			<script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
			
			<ul class="post-info">
				<li>by <a href="http://blog.cloudera.com/blog/author/aaa/" title="Posts by Amr Awadallah" rel="author">Amr Awadallah</a></li>
				<li>September 28, 2009</li>
				<li class="comment"><a href="#comments">6 comments</a></li>
				
			</ul>
			
			<div class="text-block">
				<blockquote><p><em>(guest blog post by <a href="http://www.linkedin.com/in/peterskomoroch">Pete Skomoroch</a>)</em></p></blockquote>
<p>In a <a title="traching trends with hadoop and hive" href="http://blog.cloudera.com/blog/2009/07/31/tracking-trends-with-hadoop-and-hive-on-ec2/">previous post</a>, I outlined how to build a basic trend tracking site called <a href="http://www.trendingtopics.org">trendingtopics.org</a> with <a href="http://www.cloudera.com/hadoop">Cloudera&#8217;s Distribution for Hadoop</a> and <a href="http://hadoop.apache.org/hive/">Hive</a>.&#160; TrendingTopics uses Hadoop to identify the top articles trending on Wikipedia and displays related news stories and charts.&#160; The data powering the site was pulled from an <a href="http://aws.amazon.com/ebs/">Amazon EBS</a> <a href="http://www.datawrangling.com/wikipedia-page-traffic-statistics-dataset">Wikipedia Public Dataset</a> containing 8 months of hourly pageview logfiles.&#160; In addition to the pageview logs, the EBS data volume also includes the full text content and link graph for all articles.&#160; This post will use that link graph data to build a new feature for our site: grouping related articles together under a single &#8220;lead trend&#8221; to ensure the homepage isn&#8217;t dominated by a single news story.</p>
<p><strong>Finding Related Trends Using Wikipedia Link Graph Data</strong></p>
<p>For several weeks this summer, the death of Michael Jackson dominated the news and <a href="http://searchengineland.com/michael-jackson-extraordinary-day-in-search-21641">drove a large number of pageviews on Wikipedia</a>.&#160;&#160; The hourly data in the following chart was downloaded from trendingtopics.org during the last week in June:</p>
<div style="text-align: center;"><img style="width: 648px; height: 443px;" src="https://docs.google.com/File?id=accg8khj3q9b_97ftdhqcht_b" alt="" /></div>
<p>This burst of interest in the Jackson family, Michael&#8217;s albums, and his medical conditions pushed most topics unrelated to MJ off the front page of our site:</p>
<div style="text-align: center;"><a title="MJ Trends Flood Trending Topics" href="http://www.trendingtopics.org"><img style="width: 499px; height: 457px;" src="https://docs.google.com/File?id=accg8khj3q9b_99dh5gx7g7_b" alt="" /></a></div>
<p>Ideally, TrendingTopics would continue to show a range of stories when this type of event happens.&#160; Automated news sites like <a title="Techmeme" href="http://www.techmeme.com">Techmeme</a> or <a href="http://news.google.com/">Google News</a> display clusters of rising articles across a number of topics to provide a better mix of content on the homepage.&#160;&#160; For example, Techmeme shows a ranked list of related blog posts that link back to the lead article for each story:</p>
<div style="text-align: center;"><a title="techmeme" href="http://www.techmeme.com" target="_self"><img src="https://docs.google.com/File?id=accg8khj3q9b_95f42tw4d8_b" alt="" width="538" height="364" /></a></div>
<p>We can build a simple version of this functionality with Hadoop by combining the article trend estimates we computed in the previous post with the Wikipedia link graph.&#160; Wikipedia provides a periodic <a href="http://download.wikimedia.org/enwiki/">database dump</a> which includes a file with the outgoing pagelinks for each article.&#160; The June data dump includes a 12GB pagelink file named &#8220;enwiki-20090618-pagelinks.sql&#8221; containing ~ 13K SQL insert statements:</p>
<pre>INSERT INTO `pagelinks` VALUES (5588,0,'Pinar_del_R&#237;o'),(5588,0,'Planned_economy'),..
INSERT INTO `pagelinks` VALUES (5845,0,'Attorney_General_of_Colombia'),(5845,0,'Auditor_General_of_Colombia'),...
INSERT INTO `pagelinks` VALUES (6187,0,'Wallraf-Richartz_Museum'),(6187,0,'Wangen_im_Allg&#228;u'),...
...</pre>
<p>The first step in our data preparation uses a <a href="http://hadoop.apache.org/common/docs/r0.15.2/streaming.html">Hadoop Streaming</a> job to convert the Mediawiki SQL insert format into a tab delimited text file ready for further processing with Hive.&#160; The job uses a <a href="http://www.michael-noll.com/wiki/Writing_An_Hadoop_MapReduce_Program_In_Python">Python mapper</a> called &#8220;parse_links.py&#8221; to convert the SQL insert statements into a tab delimited format.&#160; The &#8220;parse_links.py&#8221; script uses a regular expression to extract the graph edges from each SQL statement and emits tab-delimited record if the page_id belongs to <a href="http://en.wikipedia.org/wiki/Main_namespace">namespace</a> 0 (this indicates the page is an article).</p>
<p><strong>parse_links.py</strong></p>
<pre>import sys, os, re

insert_regex = re.compile('''INSERT INTO \`pagelinks\` VALUES (.*)\;''')
row_regex = re.compile("""(.*),(.*),'(.*)'""")

for line in sys.stdin:
  match = insert_regex.match(line.strip())
  if match is not None:
    data = match.groups(0)[0]
    rows = data[1:-1].split("),(")
    for row in rows:
      row_match = row_regex.match(row)
      if row_match is not None:
        # &gt;&gt;&gt; row_match.groups()
        # (12,0,'Anti-statism')
        # # page_id, pl_namespace, pl_title
        if row_match.groups()[1] == '0':
          page_id, pl_title = row_match.groups()[0], row_match.groups()[2]
          sys.stdout.write('%s\t%s\n' % (page_id, pl_title))</pre>
<p>You can test this script at the unix command line on a single machine before running it on Hadoop.&#160; Here we pipe a sample of the file into the mapper script and then examine the results with grep.&#160; The first column of the resulting output is the Wikipedia page_id and the second column contains other Wikipedia article titles linked to by that page_id.</p>
<pre>$ head -35 enwiki-20090618-pagelinks.sql | ./parse_links.py &gt; links.txt

$ grep 'Super' links.txt | more
303&#160;&#160; &#160;Super_Outbreak
303&#160;&#160; &#160;Talladega_Superspeedway
324&#160;&#160; &#160;Super_Bowl
594&#160;&#160; &#160;Tarquinius_Superbus
615&#160;&#160; &#160;List_of_Super_Bowl_champions
615&#160;&#160; &#160;List_of_Super_Bowl_records
615&#160;&#160; &#160;Super_Bowl
615&#160;&#160; &#160;Super_Bowl_XIX</pre>
<p>We ran this script on the entire pagelinks file using a temporary <a href="http://archive.cloudera.com/docs/ec2.html">Cloudera Hadoop cluster on Amazon EC2</a>, and saved the output of the conversion process in an <a href="http://wiki.apache.org/hadoop/AmazonS3">Amazon S3</a> folder called &#8220;links&#8221;.&#160; To work with these tab delimited link files on a new Hadoop cluster, we use <a href="http://hadoop.apache.org/common/docs/r0.20.0/distcp.html">distcp</a> on the master node to pull the output data into HDFS from S3.&#160;&#160; We also pull in an archived export of our trendingtopics &#8220;pages&#8221; data which contains the page_id -&gt; title mapping and monthly trend score for each article:</p>
<pre>$ hadoop distcp s3n://trendingtopics/wikidump/links links
$ hadoop fs -rmr links/_distcp_logs*
$ hadoop distcp s3n://trendingtopics/archive/20090816/pages pages
$ hadoop fs -rmr pages/_distcp_logs*</pre>
<p>We will use a set of Hive queries on the link graph data to generate the ranked list of top trending articles linking back to each Wikipedia.&#160; After our data is in hdfs, we can start the Hive CLI on the Hadoop master node:</p>
<pre>$ hive</pre>
<p>In the Hive shell, we create a &#8220;links&#8221; table and load the raw data from hdfs:</p>
<pre>hive&gt; CREATE TABLE links (
&#160;page_id BIGINT,
&#160;pl_title STRING)
&#160; ROW FORMAT DELIMITED
&#160;&#160;&#160; FIELDS TERMINATED BY '\t'
&#160; STORED AS TEXTFILE;

hive&gt; LOAD DATA INPATH 'links' OVERWRITE INTO TABLE links;</pre>
<p>Now we have the &#8220;outlink&#8221; data for each page in Hive, but we want to reverse the keys so that we can find all trending page titles which link back to a given page_id.&#160; We can map the original page_id&#8217;s to article titles and pull in the trend data using a <a href="http://wiki.apache.org/hadoop/Hive/Tutorial">Hive JOIN</a>:</p>
<pre>hive&gt; CREATE TABLE temp_backlinks (
    pl_title STRING,
    page_id BIGINT,
    bl_title STRING,
    monthly_trend DOUBLE)
  ROW FORMAT DELIMITED
    FIELDS TERMINATED BY '01'
  STORED AS TEXTFILE;

hive&gt; INSERT OVERWRITE TABLE temp_backlinks
select links.pl_title, pages.page_id,
  pages.redirect_title, pages.monthly_trend
from links JOIN pages ON (pages.page_id = links.page_id);</pre>
<p>A second join is used to convert the original outlink titles to page_ids for use in our web application&#8217;s MySQL database:</p>
<pre>hive&gt; CREATE TABLE backlinks (
&#160; page_id BIGINT,
&#160;&#160; &#160;bl_title STRING,
&#160;&#160; &#160;monthly_trend DOUBLE)
&#160; ROW FORMAT DELIMITED
&#160;&#160;&#160; FIELDS TERMINATED BY '01'
&#160; STORED AS TEXTFILE;

hive&gt; INSERT OVERWRITE TABLE backlinks
select pages.page_id,
&#160;&#160; &#160;temp_backlinks.bl_title,
&#160;&#160; &#160;temp_backlinks.monthly_trend
from pages JOIN temp_backlinks
ON (pages.redirect_title = temp_backlinks.pl_title);</pre>
<p>The final stage of processing involves generating an array of the top trending backlink urls for each Wikipedia page_id.&#160; Later on, we can export the entire lookup table &#8220;backlinks_reduced&#8221; to MySQL for use in the trendingtopics Rails app.&#160; We use a <a href="http://wiki.apache.org/hadoop/Hive/LanguageManual/Transform">Hive transform</a> written in Python to rank the backlinks and concatenate the top 10 titles into a comma delimited text string for each page_id:</p>
<pre>hive&gt; CREATE TABLE backlinks_reduced (
&#160;&#160;&#160; page_id BIGINT,
&#160;&#160; &#160;backlinks STRING)
&#160; ROW FORMAT DELIMITED
&#160;&#160; &#160;FIELDS TERMINATED BY '01'
&#160; STORED AS TEXTFILE;

hive&gt; add FILE /mnt/hive_backlink_mapper.py;
hive&gt; add FILE /mnt/hive_backlink_reducer.py;

hive&gt; FROM (
&#160; FROM backlinks
&#160; MAP backlinks.page_id, backlinks.bl_title, backlinks.monthly_trend
&#160; USING 'python hive_backlink_mapper.py'
&#160; CLUSTER BY key) map_output
INSERT OVERWRITE TABLE backlinks_reduced
&#160; REDUCE map_output.key, map_output.value
&#160; USING 'python hive_backlink_reducer.py'
&#160; AS page_id, backlinks;</pre>
<p>The streaming mapper and reducer we used are shown below:</p>
<p><strong>hive_backlink_mapper.py</strong></p>
<pre>import sys, os

for line in sys.stdin:
  try:
    page_id, bl_title, score = line.strip().split("\t")
    sys.stdout.write('%s\t%s\t%s\n' % (page_id, bl_title, score))
  except:
    # just skip possible bad rows for now
    pass</pre>
<p><strong>hive_backlink_reducer.py</strong></p>
<pre>import sys, os

def top_backlinks(backlinks, scores):
  # return top 10 backlinks based on score metric (trend)
  scorevals,links = zip( *sorted( zip (scores,backlinks)))
  toplinks = list(links)
  toplinks.reverse()
  backlink_str = '[%s]' % ','.join(toplinks[:10])
  return backlink_str

#  For each page, emit backlinks sorted by score desc
last_page, backlinks, scores = None, [], []
for line in sys.stdin:
  try:
    (page, backlink, score) = line.strip().split("\t")
    if last_page != page and last_page is not None:
      backlink_string = top_backlinks(backlinks, scores)
      print "%s\t%s" % (last_page, backlink_string)
      backlinks = []
      scores = []
    last_page = page
    backlinks.append(backlink)
    scores.append(float(score))
  except:
    pass
backlink_string = top_backlinks(backlinks, scores)
print "%s\t%s" % (last_page, backlink_string)</pre>
<p>To examine the results, we run a join query against the pages table to find the top trending backlinks for the Wikipedia article on &#8220;Swine Flu&#8221;:<strong><br />
</strong></p>
<pre>hive&gt; SELECT backlinks_reduced.backlinks FROM backlinks_reduced
         JOIN pages ON (pages.page_id = backlinks_reduced.page_id)
         WHERE redirect_title="<strong>Swine_influenza</strong>";

[Influenza_A_virus_subtype_H1N1,1918_flu_pandemic,Guillain-Barr&#233;_syndrome,
Oseltamivir,Influenza_treatment,Influenza_vaccine,Zanamivir,
Orthomyxoviridae,Pig,Amantadine]</pre>
<p>This looks like a reasonable list of related pages.&#160; Here are a few more trending topics from the same time period:</p>
<pre><strong>Julia Child</strong>
[Julie_Powell,Julie_&amp;_Julia,August_13,August_15,Meryl_Streep,
Mastering_the_Art_of_French_Cooking,Le_Cordon_Bleu,Amy_Adams,
Simone_Beck,The_French_Chef]</pre>
<pre><strong>John Hughes</strong>
[The_Breakfast_Club,Molly_Ringwald,Sixteen_Candles,Pretty_in_Pink,
Weird_Science_(film),Some_Kind_of_Wonderful_(film),Curly_Sue,
Home_Alone_3,Uncle_Buck,Home_Alone_(film)]</pre>
<pre><strong>Quentin Tarantino</strong>
[Inglourious_Basterds,Machete_(film),Pulp_Fiction_(film),
Eli_Roth,Bruce_Willis,Rosario_Dawson,Robert_Rodriguez,
Grindhouse_(film),Julie_Dreyfus,Death_Proof]</pre>
<p>At this point, we have what looks like a reasonable approach for generating related links with a low amount of effort.&#160; The Rails application can apply filters to remove titles like &#8220;August_15&#8243; from each list and display the related links around each trend.</p>
<p>Here are a few ideas for next steps with the Wikipedia link graph data and Hadoop:</p>
<ul>
<li>Show related articles by using the backlink ids as a feature vector to compute article similarity</li>
<li>Use Pagerank to filter articles displayed in trends (see <a href="http://code.google.com/edu/submissions/uwashington-scalable-systems/">Running PageRank on Wikipedia)<br />
</a></li>
<li>Compute <a href="http://dumbotics.com/2009/03/15/computing-tf-idf-weights/">TFIDF weights</a> for Wikipedia articles and incorporate it into the similarity calculation</li>
</ul>
<p>If you are interested in digging deeper into the link data with Python and Hadoop, you should also check out Viraj Bhat and Jake Hofman&#8217;s talk &#8220;Cool Development Projects at Yahoo!: Automatic Tuning and Social Graph Analysis&#8221; next week at <a href="http://www.cloudera.com/hadoop-world-nyc">Hadoop World NYC</a>.&#160; I&#8217;ll also giving a talk that afternoon called &#8220;Building Data Intensive Apps: A closer look at TrendingTopics.org&#8221;</p>

				<div class="social-buttons">
<span class='st_facebook_large' displayText='Facebook'></span>
<span class='st_twitter_large' displayText='Tweet'></span>
<span class='st_linkedin_large' displayText='LinkedIn'></span>
<span class='st_googleplus_large' displayText='Google +'></span>
<span class='st_email_large' displayText='Email'></span>
				</div>
			</div>

			<div class="grid_2" style="margin:0">
  <div class="comments comments-2">
    <div class="field-under">
      <h4>Filed under:</h4>
      <ul class="post-categories">
	<li><a href="http://blog.cloudera.com/blog/category/community/" title="View all posts in Community" rel="category tag">Community</a></li>
	<li><a href="http://blog.cloudera.com/blog/category/general/" title="View all posts in General" rel="category tag">General</a></li>
	<li><a href="http://blog.cloudera.com/blog/category/hadoop/" title="View all posts in Hadoop" rel="category tag">Hadoop</a></li>
	<li><a href="http://blog.cloudera.com/blog/category/hive/" title="View all posts in Hive" rel="category tag">Hive</a></li></ul>  	</div>
  	
  <a name="comments"></a>
  <div class="comments-head">
    <strong>6 Responses</strong>
   
  </div>
  <ul class="comments-list">
  	<li>
		<em class="comment-date">
			<a rel="nofollow" href="http://www.lalitkapoor.com/blog">Lalit Kapoor</a> /
			September 28, 2009 / 10:12 AM		</em>
		<p>Pete, this is a great post. I am glad that you organized it so well. Thanks for sharing your work. This is a really cool project to replicate if you want to learn a bit and get your hands dirty.</p>
	</li>
</li>
	<li>
		<em class="comment-date">
			<a rel="nofollow" href="http://www.sematext.com/">Otis Gospodnetic</a> /
			September 28, 2009 / 2:24 PM		</em>
		<p>Pete, can you share how fast those backlinks SELECTs on a dataset this large are?</p>
	</li>
</li>
	<li>
		<em class="comment-date">
			<a rel="nofollow" href="http://www.datawrangling.com">Pete Skomoroch</a> /
			September 28, 2009 / 2:49 PM		</em>
		<p>Otis,</p>
<p>That final SELECT into backlinks_reduced took 330 seconds, which ran the streaming code on 2,445,704 rows. The example Hive selects from backlinks_reduced take around 160 seconds.  For use in a web application, I would export those final key-value pairs to MySQL and index by page_id or load them into a non-RDBMS datastore.  Hive is best for offline batch operations where you need to run against all the data or a certain partition.</p>
<p>-Pete</p>
	</li>
</li>
	<li>
		<em class="comment-date">
			<a rel="nofollow" href="http://www.datawrangling.com">Pete Skomoroch</a> /
			September 28, 2009 / 2:58 PM		</em>
		<p>Small correction found when looking at the query timings: the related links displayed are actually from another table that finds the &#8220;mutual links&#8221;, pages that are both outlinks and backlinks.  That requirement gives a more narrow set of backlink pages that are also pointed to by the target page: </p>
<p>SELECT x,y,z<br />
FROM backlinks JOIN LINKS ON (links.page_id = backlinks.page_id)<br />
WHERE links.pl_title = backlinks.bl_title;</p>
	</li>
</li>
  </ul>
  <a name="leave-comment"></a>
  <form action="/wp-comments-post.php" method="POST">
  	<div class="comment-form">
  		<h4>Leave a comment</h4>
  		<div class="row">
  			<input type="text" value="" class="txt" name="author"/>
  			<label>Name <span>required</span></label>
  		</div>
  		<div class="row">
  			<input type="text" value="" class="txt" name="email"/>
  			<label class="published">Email <span>required</span> <em>(will not be published)</em></label>
  		</div>
  		<div class="row">
  			<input type="text" value="" class="txt" name="url"/>
  			<label>Website</label>
  		</div>
  		<div class="row">
  			<textarea rows="10" cols="30" class="area" name="comment"></textarea>
  			<label>Comment</label>
  		</div>
  		<fieldset>
  			<input type="button" value="Leave Comment" class="btn cta"/>
  		</fieldset>
  	</div>
  	<input type='hidden' name='comment_post_ID' value='1350' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
  	<p class="cptch_block"><label>Prove you're human!<span class="required"> *</span></label><br />		<input type="hidden" name="cptch_result" value="JoA=" />
		<input type="hidden" name="cptch_time" value="1397910146" />
		<input type="hidden" value="Version: 2.4" />
		1 &times; <input id="cptch_input" type="text" autocomplete="off" name="cptch_number" value="" maxlength="2" size="2" aria-required="true" required="required" style="margin-bottom:0;display:inline;font-size: 12px;width: 40px;" /> =  ei&#103;&#104;&#116;	</p>  </form>
</div></section>




<!-- Google Code for New Remarketing Pixel -->
<!-- Remarketing tags may not be associated with personally identifiable information or placed on pages related to sensitive categories. For instructions on adding this tag and more information on the above requirements, read the setup guide: google.com/ads/remarketingsetup -->
<script type="text/javascript">
/* <![CDATA[ */
var google_conversion_id = 1035979479;
var google_conversion_label = "xel9CJ-P0QMQ15X_7QM";
var google_custom_params = window.google_tag_params;
var google_remarketing_only = true;
/* ]]> */
</script>
<script type="text/javascript" src="//www.googleadservices.com/pagead/conversion.js">
</script>

<noscript>
<div style="display:inline;"> <img height="1" width="1" style="border-style:none;" alt="" src="//googleads.g.doubleclick.net/pagead/viewthroughconversion/1035979479/?value=0&label=xel9CJ-P0QMQ15X_7QM&guid=ON&script=0"/> </div>
</noscript>
</section>
<span class="bg-fix"></span>
</div>
</div>
<footer id="global-footer">
<div class="footerContent parbase">
<footer>
  <div class="wrapper">
    <div class="bg-fix"></div>
    <nav>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/products-and-services.html">Products</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products/cloudera-enterprise.html">Cloudera Enterprise</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/cloudera-express.html">Cloudera Express</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/cloudera-enterprise/cloudera-manager.html">Cloudera Manager</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/cdh.html">CDH</a></li>
        <li><a href="http://www.cloudera.com/content/support/en/downloads.html">All Downloads</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/products-and-services/professional-services.html">Professional Services</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/training.html">Training</a></li>
      </ul>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/solutions.html">Solutions</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/solutions/enterprise-solutions.html">Enterprise Solutions</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/solutions/partner.html">Partner Solutions</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/solutions/industries.html">Industry Solutions</a></li>
      </ul>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/partners.html">Partners</a></li>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/resources/library.html">Resource Library</a></li>
        <li class="section"><a href="https://ccp.cloudera.com/display/SUPPORT/Get+Support">Support</a></li>
      </ul>
      <ul>
        <li class="section"><a href="http://www.cloudera.com/content/cloudera/en/about.html">About</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/hadoop-and-big-data.html">Hadoop &amp; Big Data</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/management.html">Management Team</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/board.html">Board</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/events.html">Events</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/press-center.html">Press Center</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/careers.html">Careers</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/about/contact-form.html">Contact Us</a></li>
        <li><a href="http://www.cloudera.com/content/cloudera/en/subscription-center.html">Subscription Center</a></li>
      </ul>
      <div class="locale-and-social" style="float:right">
        <div>
          <div class="locale-and-social">
            <div class="locale">
              <select onchange="this.options[this.selectedIndex].value &amp;&amp; (window.location = this.options[this.selectedIndex].value);" class="site-language">
                <option value="http://www.cloudera.com" name="English">English</option>
                <option value="http://www.cloudera.co.jp/">Japanese</option>
              </select>
            </div>
            <div class="social"><span class="follow">Follow us:</span><span class="share">Share:<i class="icon-share"></i></span>
              <ul>
                <li><a class="linkedIn" target="_blank" href="http://www.linkedin.com/company/cloudera">LinkedIn</a></li>
                <li><a class="twitter" target="_blank" href="http://twitter.com/cloudera">Twitter</a></li>
                <li><a class="facebook" target="_blank" href="http://www.facebook.com/cloudera">Facebook</a></li>
                <li><a class="youtube" target="_blank" href="http://www.youtube.com/user/clouderahadoop">YouTube</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>
    <nav class="global-footer"><span class="logo"><a>Cloudera</a></span>
      <address>
      <span>Cloudera, Inc.</span> <span><a target="_blank" href="http://www.google.com/maps?q=1001+Page+Mill+Rd,+Palo+Alto,+CA+94306">1001 Page Mill Road Bldg 2</a></span> <span>Palo Alto, CA 94304</span>
      </address>
      <address>
      <span><a href="http://www.cloudera.com">www.cloudera.com</a></span> <span>US: 1-888-789-1488</span> <span>Intl: 1-650-362-0488</span>
      </address>
      <div class="copyright"><span><span class="piped">©2014 Cloudera, Inc. All rights reserved</span><span class="piped"><a href="http://www.cloudera.com/content/cloudera/en/terms-of-service.html">Terms &amp; Conditions</a></span><a href="http://www.cloudera.com/content/cloudera/en/privacy-policy.html">Privacy Policy</a></span> <span>Hadoop and the Hadoop elephant logo are trademarks of the <a target="_blank" href="http://www.apache.org/">Apache Software Foundation</a>.</span></div>
    </nav>
  </div>
</footer>
<script type='text/javascript' src='http://blog.cloudera.com/wp-content/plugins/prettify-gc-syntax-highlighter/prettify.js?ver=3.3.2'></script>
<script type='text/javascript' src='http://blog.cloudera.com/wp-content/plugins/prettify-gc-syntax-highlighter/launch.js?ver=3.3.2'></script>
<div class="modal" style="display:none">
  <div id="password-required">
    <div class="inner"> </div>
  </div>
</div>
<div class="tooltip" class="tooltip" style="display:none">
</div>
<script type="text/javascript" src="http://dnn506yrbagrg.cloudfront.net/pages/scripts/0011/2160.js"></script>
<script type="text/javascript">var _kiq = _kiq || [];</script> 
<script type="text/javascript" src="http://s3.amazonaws.com/ki.js/14646/2Sr.js" async></script>
</body></html>
